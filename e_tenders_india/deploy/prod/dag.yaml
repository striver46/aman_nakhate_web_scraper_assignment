apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: eti-cron-wf
  namespace: %ENV%
spec:
  serviceAccountName: workflow
  schedule: "30 7 * * *"
  concurrencyPolicy: "Replace"
  startingDeadlineSeconds: 0
  successfulJobsHistoryLimit: 10
  suspend: True 
  workflowSpec:
    serviceAccountName: workflow
    ttlStrategy:
      secondsAfterCompletion: 1800 # Time to live after workflow is completed, replaces ttlSecondsAfterFinished
      secondsAfterSuccess: 1800 
    entrypoint: diamond
    onExit: exit-handler
    templates:
    - name: exit-handler
      steps:
      - - name: success
          template: success
          when: "{{workflow.status}} == Succeeded"
        - name: faliure
          template: faliure
          when: "{{workflow.status}} != Succeeded"
    - name: success
      container:
        env:
          - name: SLACK_WEBHOOK
            valueFrom:
              secretKeyRef:
                key: url
                name: slack-webhook
        image: 965994533236.dkr.ecr.eu-west-3.amazonaws.com/slack_bot_dags:v0.0.1
        command: ["python3"] 
        args: [ 
          "main.py",
          "{{workflow.name}}",
          "{{workflow.namespace}}", "{{workflow.scheduledTime}}",
          "{{workflow.status}}", "{{workflow.duration}}",
        ]
    - name: faliure
      container:
        env:
          - name: SLACK_WEBHOOK
            valueFrom:
              secretKeyRef:
                key: url
                name: slack-webhook
        image: 965994533236.dkr.ecr.eu-west-3.amazonaws.com/slack_bot_dags:v0.0.1
        command: ["python3"] 
        args: [ 
          "main.py",
          "{{workflow.name}}",
          "{{workflow.namespace}}", "{{workflow.scheduledTime}}",
          "{{workflow.status}}", "{{workflow.duration}}",
          "{{workflow.failures}}"
        ]
    - name: eti
      inputs:
        parameters:
        - name: step
      container:
        requests:
          cpu: 4000m
          memory: 16Gi
        image: 965994533236.dkr.ecr.eu-west-3.amazonaws.com/projects_e_tenders_india/ingestion:%TAG%
        command: ["python3", "client.py", "--step", "{{inputs.parameters.step}}"]
        env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-key
              key: username
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-key
              key: password
        - name: ELASTICSEARCH_URL
          valueFrom:
            secretKeyRef:
              name: elastic-key
              key: url
        - name: ELASTICSEARCH_USER
          valueFrom:
            secretKeyRef:
              name: elastic-key
              key: username
        - name: ELASTICSEARCH_PASS
          valueFrom:
            secretKeyRef:
              name: elastic-key
              key: password
    - name: diamond
      dag:
        tasks:
        - name: MainScraper
          template: eti
          arguments:
            parameters: [{name: step, value: 1}]
        - name: Cleaner
          dependencies: [MainScraper]
          template: eti
          arguments:
            parameters: [{name: step, value: 2}]
        - name: Geocoder
          dependencies: [Cleaner]
          template: eti
          arguments:
            parameters: [{name: step, value: 3}]
        - name: Standardiser
          dependencies: [Geocoder]
          template: eti
          arguments:
            parameters: [{name: step, value: 4}]
        - name: ElasticSearchIngestion
          dependencies: [Standardiser]
          template: eti
          arguments:
            parameters: [{name: step, value: 5}]